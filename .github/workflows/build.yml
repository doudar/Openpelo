name: Build Executables

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [created]

jobs:
  bump-version:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Bump version and push tag
        run: |
          # Read current version
          VERSION=$(python -c "import json; print(json.load(open('version.json'))['version'])")
          
          # Split version into components
          IFS='.' read -r -a VERSION_PARTS <<< "$VERSION"
          MAJOR="${VERSION_PARTS[0]}"
          MINOR="${VERSION_PARTS[1]}"
          PATCH="${VERSION_PARTS[2]}"
          
          # Increment patch version
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          
          # Update version.json
          echo "{\"version\": \"$NEW_VERSION\"}" > version.json
          
          # Configure Git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Commit version update
          git add version.json
          git commit -m "Bump version to $NEW_VERSION"
          
          # Create and push tag
          git tag -a "v$NEW_VERSION" -m "Version $NEW_VERSION"
          git push origin main --tags
          git push

  build-windows:
    needs: [bump-version]
    runs-on: windows-latest
    if: github.event_name == 'push' || github.event_name == 'release'
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install nuitka zstandard certifi pillow
    
    - name: Build executable
      run: |
        python -m nuitka `
          --standalone `
          --onefile `
          --enable-plugin=tk-inter `
          --assume-yes-for-downloads `
          --include-package=certifi `
          --include-data-file=apps_config.json=apps_config.json `
          --include-data-file=usb_debug_steps.json=usb_debug_steps.json `
          --include-data-file=wireless_adb_steps.json=wireless_adb_steps.json `
          --include-data-dir=ADB=ADB `
          --include-data-dir=platform-tools=platform-tools `
          --windows-console-mode=disable `
          --windows-icon-from-ico=Icon.ico `
          --output-filename=OpenPelo.exe `
          --output-dir=build/windows `
          --remove-output `
          openpelo.py
        New-Item -ItemType Directory -Path dist -Force | Out-Null
        Copy-Item build/windows/OpenPelo.exe dist/OpenPelo.exe
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenPelo-Windows
        path: dist/OpenPelo.exe

  build-linux:
    needs: [bump-version]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'release'
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install Tk system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-tk tk-dev
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install nuitka zstandard certifi pillow
    
    - name: Build executable
      run: |
        python -m nuitka \
          --standalone \
          --onefile \
          --enable-plugin=tk-inter \
          --include-package=certifi \
          --include-data-file=apps_config.json=apps_config.json \
          --include-data-file=usb_debug_steps.json=usb_debug_steps.json \
          --include-data-file=wireless_adb_steps.json=wireless_adb_steps.json \
          --include-data-dir=ADB=ADB \
          --include-data-dir=platform-tools=platform-tools \
          --output-filename=OpenPelo \
          --output-dir=build/linux \
          --remove-output \
          openpelo.py
        mkdir -p dist
        cp build/linux/OpenPelo dist/OpenPelo
        chmod +x dist/OpenPelo
        tar -czf dist/OpenPelo-linux.tar.gz -C dist OpenPelo
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenPelo-Linux
        path: dist/OpenPelo-linux.tar.gz

  build-macos-arm:
    needs: [bump-version]
    runs-on: macos-latest
    if: github.event_name == 'push' || github.event_name == 'release'
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install nuitka zstandard certifi pillow

    - name: Install Apple Certificate
      if: runner.os == 'macOS'
      env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.P12_PASSWORD }}
      run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Import certificate and provision profile from secrets
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
    
    - name: Build executable
      run: |
        python -m nuitka \
          --standalone \
          --onefile \
          --enable-plugin=tk-inter \
          --include-package=certifi \
          --include-data-file=apps_config.json=apps_config.json \
          --include-data-file=usb_debug_steps.json=usb_debug_steps.json \
          --include-data-file=wireless_adb_steps.json=wireless_adb_steps.json \
          --include-data-dir=ADB=ADB \
          --macos-disable-console \
          --include-data-dir=platform-tools=platform-tools \
          --output-filename=OpenPelo \
          --output-dir=build/macos-arm \
          --remove-output \
          openpelo.py
        chmod +x build/macos-arm/OpenPelo
        mkdir -p dist
        cp build/macos-arm/OpenPelo dist/OpenPelo
    
    - name: Sign Executable
      run: |
        codesign --force --verbose --timestamp --options runtime --sign "${{ secrets.CODESIGN_IDENTITY }}" dist/OpenPelo

    - name: Package executable
      run: |
        cd dist
        zip OpenPelo-macOS-ARM.zip OpenPelo
        cd ..

    - name: Notarize Build
      run: |
        xcrun notarytool submit dist/OpenPelo-macOS-ARM.zip \
          --apple-id "${{ secrets.AC_USERNAME }}" \
          --password "${{ secrets.AC_PASSWORD }}" \
          --team-id "${{ secrets.TEAM_ID }}" \
          --wait
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenPelo-macOS-ARM
        path: dist/OpenPelo-macOS-ARM.zip

  build-macos-intel:
    needs: [bump-version]
    runs-on: macos-latest
    if: github.event_name == 'push' || github.event_name == 'release'
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        architecture: 'x64'

    - name: Install Rosetta
      run: |
        sudo softwareupdate --install-rosetta --agree-to-license
    
    - name: Install dependencies
      run: |
        arch -x86_64 python -m pip install --upgrade pip
        arch -x86_64 python -m pip install nuitka zstandard certifi pillow

    - name: Install Apple Certificate
      if: runner.os == 'macOS'
      env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.P12_PASSWORD }}
      run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Import certificate and provision profile from secrets
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
    
    - name: Build executable
      run: |
        arch -x86_64 python -m nuitka \
          --standalone \
          --onefile \
          --enable-plugin=tk-inter \
          --include-package=certifi \
          --include-data-file=apps_config.json=apps_config.json \
          --include-data-file=usb_debug_steps.json=usb_debug_steps.json \
          --include-data-file=wireless_adb_steps.json=wireless_adb_steps.json \
          --include-data-dir=ADB=ADB \
          --include-data-dir=platform-tools=platform-tools \
          --macos-disable-console \
          --output-filename=OpenPelo \
          --output-dir=build/macos-intel \
          --remove-output \
          openpelo.py
        chmod +x build/macos-intel/OpenPelo
        mkdir -p dist
        cp build/macos-intel/OpenPelo dist/OpenPelo

    - name: Sign Executable
      run: |
        codesign --force --verbose --timestamp --options runtime --sign "${{ secrets.CODESIGN_IDENTITY }}" dist/OpenPelo
    
    - name: Package executable
      run: |
        cd dist
        zip OpenPelo-macOS-Intel.zip OpenPelo
        cd ..

    - name: Notarize Build
      run: |
        xcrun notarytool submit dist/OpenPelo-macOS-Intel.zip \
          --apple-id "${{ secrets.AC_USERNAME }}" \
          --password "${{ secrets.AC_PASSWORD }}" \
          --team-id "${{ secrets.TEAM_ID }}" \
          --wait
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenPelo-macOS-Intel
        path: dist/OpenPelo-macOS-Intel.zip

  build-macos-universal:
    needs: [build-macos-arm, build-macos-intel]
    runs-on: macos-latest
    if: github.event_name == 'push' || github.event_name == 'release'
    steps:
    - name: Download ARM artifact
      uses: actions/download-artifact@v4
      with:
        name: OpenPelo-macOS-ARM
        path: arm

    - name: Download Intel artifact
      uses: actions/download-artifact@v4
      with:
        name: OpenPelo-macOS-Intel
        path: intel

    - name: Install Apple Certificate
      if: runner.os == 'macOS'
      env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.P12_PASSWORD }}
      run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Import certificate and provision profile from secrets
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

    - name: Create and Sign universal binary
      run: |
        unzip arm/OpenPelo-macOS-ARM.zip -d arm_extracted
        unzip intel/OpenPelo-macOS-Intel.zip -d intel_extracted
        mkdir -p dist
        
        # Combine the two binaries
        lipo -create arm_extracted/OpenPelo intel_extracted/OpenPelo -output dist/OpenPelo
        
        # Sign the new universal binary
        codesign --force --verbose --timestamp --options runtime --sign "${{ secrets.CODESIGN_IDENTITY }}" dist/OpenPelo
        
        # Zip it for distribution
        cd dist
        zip OpenPelo-macOS-universal.zip OpenPelo
        cd ..

    - name: Notarize Build
      run: |
        xcrun notarytool submit dist/OpenPelo-macOS-universal.zip \
          --apple-id "${{ secrets.AC_USERNAME }}" \
          --password "${{ secrets.AC_PASSWORD }}" \
          --team-id "${{ secrets.TEAM_ID }}" \
          --wait

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenPelo-macOS-universal
        path: dist/OpenPelo-macOS-universal.zip

  create-release:
    needs: [build-windows, build-linux, build-macos-arm, build-macos-intel, build-macos-universal]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
      
    - name: Get version
      id: get_version
      run: |
        VERSION=$(cat version.json | jq -r .version)
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Upload Release Assets
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.get_version.outputs.version }}
        name: Release v${{ steps.get_version.outputs.version }}
        files: |
          OpenPelo-Windows/OpenPelo.exe
          OpenPelo-Linux/OpenPelo-linux.tar.gz
          OpenPelo-macOS-ARM/OpenPelo-macOS-ARM.zip
          OpenPelo-macOS-Intel/OpenPelo-macOS-Intel.zip
          OpenPelo-macOS-universal/OpenPelo-macOS-universal.zip
